<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications Web</title>
    
    <!-- Import Firebase -->
    <script src="https://www.gstatic.com/firebasejs/11.2.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.2.0/firebase-messaging-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.2.0/firebase-auth-compat.js"></script>
</head>
<body>
    <h1>Bienvenue sur mon site de notifications !</h1>
    <p>Ce site recevra des notifications push.</p>

    <h2>Connexion / Inscription</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Mot de passe">
    <button id="signupButton">S'inscrire</button>
    <button id="loginButton">Se connecter</button>
    <button id="logoutButton" style="display:none;">Se d√©connecter</button>
    
    <p id="authStatus">üîÑ V√©rification de l'√©tat de connexion...</p> 

    <!-- Bouton pour activer les notifications -->
    <button id="notifButton">Activer les notifications</button>

    <script>
        // üìå Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyASQVCg8yyA_oRBn_PnGQUYTg4WwHjqByI",
            authDomain: "pc-scraper-poc.firebaseapp.com",
            projectId: "pc-scraper-poc",
            storageBucket: "pc-scraper-poc.firebasestorage.app",
            messagingSenderId: "474435730603",
            appId: "1:474435730603:web:ddd69a9b3cbc88de24cbee"
        };

        // Initialise Firebase
        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();

        // üìå Enregistrer manuellement le Service Worker et r√©cup√©rer le Token FCM
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/notifications-web/firebase-messaging-sw.js')
                .then((registration) => {
                    console.log("‚úÖ Service Worker enregistr√© avec succ√®s :", registration);

                    // üìå Ajouter un √©couteur sur le bouton pour activer les notifications
                    document.getElementById("notifButton").addEventListener("click", () => {
                        Notification.requestPermission().then((permission) => {
                            if (permission === "granted") {
                                messaging.getToken({ serviceWorkerRegistration: registration }) // ‚úÖ Correction ici !
                                    .then((token) => {
                                        console.log("‚úÖ Token FCM re√ßu :", token);
                                        alert("Notifications activ√©es ! V√©rifie la console (F12) pour voir le token.");
                                    })
                                    .catch((err) => {
                                        console.log("‚ùå Erreur lors de la r√©cup√©ration du token", err);
                                    });
                            } else {
                                alert("‚ùå Permission refus√©e. Activez les notifications dans les param√®tres du navigateur.");
                            }
                        });
                    });
                })
                .catch((error) => {
                    console.log("‚ùå Erreur lors de l‚Äôenregistrement du Service Worker :", error);
                });
        }        

        // √âcouter les notifications re√ßues pendant que l'utilisateur est sur la page
        messaging.onMessage((payload) => {
            console.log("üì© Notification re√ßue :", payload);
            alert(payload.notification.title + "\n" + payload.notification.body);
        });

        // üìå Importer Firebase Auth
        const auth = firebase.auth();
        console.log("‚úÖ Firebase initialis√© avec succ√®s !");

        // üìå V√©rifier l'√©tat de connexion au chargement de la page
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log("‚úÖ Utilisateur connect√© :", user.email);
                document.getElementById("authStatus").innerText = `‚úÖ Connect√© en tant que ${user.email}`;
                document.getElementById("logoutButton").style.display = "block";
            } else {
                console.log("‚ùå Aucun utilisateur connect√©.");
                document.getElementById("authStatus").innerText = "‚ùå Non connect√©";
                document.getElementById("logoutButton").style.display = "none";
            }
        });

        // üìå Inscription d'un nouvel utilisateur
        document.getElementById("signupButton").addEventListener("click", () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log("‚úÖ Utilisateur cr√©√© :", userCredential.user.email);
                    alert("Compte cr√©√© avec succ√®s !");
                })
                .catch((error) => {
                    console.log("‚ùå Erreur d'inscription :", error.message);
                    alert(error.message);
                });
        });

        // üìå Connexion d'un utilisateur existant
        document.getElementById("loginButton").addEventListener("click", () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log("‚úÖ Connect√© :", userCredential.user.email);
                    alert("Connexion r√©ussie !");
                })
                .catch((error) => {
                    console.log("‚ùå Erreur de connexion :", error.message);
                    alert(error.message);
                });
        });

        // üìå D√©connexion
        document.getElementById("logoutButton").addEventListener("click", () => {
            auth.signOut().then(() => {
                console.log("‚úÖ D√©connect√© avec succ√®s");
                alert("D√©connexion r√©ussie !");
            }).catch((error) => {
                console.log("‚ùå Erreur lors de la d√©connexion :", error.message);
            });
        });

    </script>
</body>
</html>
